# v7.0 Phase 1: LangGraph ì—ì´ì „íŠ¸ ì•„í‚¤í…ì²˜

## ğŸ—ï¸ ì•„í‚¤í…ì²˜ ê°œìš”

v7.0ì˜ í•µì‹¬ì€ ì„ í˜• ë¶„ë¥˜ í•¨ìˆ˜ì—ì„œ LangGraphë¥¼ ì‚¬ìš©í•œ **ìƒíƒœ ê¸°ë°˜ ì—ì´ì „íŠ¸ ì›Œí¬í”Œë¡œìš°**ë¡œì˜ ì „í™˜ì…ë‹ˆë‹¤.

### í˜„ì¬ vs ì‹ ê·œ

| ê¸°ëŠ¥ | v6.0 (í˜„ì¬) | v7.0 (LangGraph ì—ì´ì „íŠ¸) |
|---|---|---|
| **ë¡œì§** | ì„ í˜• (ì…ë ¥ â†’ LLM â†’ ì¶œë ¥) | **ìˆœí™˜ ê·¸ë˜í”„** (ì…ë ¥ â†’ ë…¸ë“œ â†’ ì¡°ê±´ë¶€ ì—£ì§€ â†’ ë…¸ë“œ...) |
| **ì»¨í…ìŠ¤íŠ¸** | ë¬´ìƒíƒœ (ì›ìƒ·) | **ìƒíƒœ ê¸°ë°˜** (ëŒ€í™”/ì¶”ë¡  ì´ë ¥ ìœ ì§€) |
| **ì—ëŸ¬ ì²˜ë¦¬** | ë‹¨ìˆœ Try/Except | **ìê°€ ìˆ˜ì • ë£¨í”„** (í”¼ë“œë°±ê³¼ í•¨ê»˜ ì¬ì‹œë„) |
| **ì¶œë ¥** | ê³ ì • ìŠ¤í‚¤ë§ˆ (Pydantic) | **êµ¬ì¡°í™”ëœ ì¶œë ¥** + ì¶”ë¡  ì¶”ì  |

---

## ğŸ§  ì—ì´ì „íŠ¸ ì›Œí¬í”Œë¡œìš° (ê·¸ë˜í”„)

```mermaid
graph TD
    Start([ì‹œì‘]) --> InputAnalysis
    InputAnalysis --> ContextRetrieval
    ContextRetrieval --> Classification
    Classification --> Validation
    Validation -- ì‹ ë¢°ë„ > 70% --> End([ì¢…ë£Œ])
    Validation -- ì‹ ë¢°ë„ < 70% --> Reflection
    Reflection --> Classification
```

### ë…¸ë“œ ì„¤ëª…

1.  **InputAnalysis (ì…ë ¥ ë¶„ì„)**:
    - ì‚¬ìš©ì ì…ë ¥(íŒŒì¼ ë‚´ìš©)ì—ì„œ í•µì‹¬ í‚¤ì›Œë“œì™€ ì˜ë„ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.
    - ì˜ˆ: "ì´ ë¬¸ì„œëŠ” 2025ë…„ ë§ˆì¼€íŒ… ì˜ˆì‚°ì•ˆì…ë‹ˆë‹¤." â†’ Entity: `Marketing`, `Budget`, `2025`

2.  **ContextRetrieval (ë§¥ë½ ê²€ìƒ‰)**:
    - ì¶”ì¶œëœ í‚¤ì›Œë“œë¡œ ê¸°ì¡´ ìœ ì‚¬ ë¬¸ì„œë¥¼ ê²€ìƒ‰(ë²¡í„° ê²€ìƒ‰)í•˜ê±°ë‚˜ ì‚¬ìš©ì í”„ë¡œí•„(ì˜¨ë³´ë”© ë°ì´í„°)ì„ ì°¸ì¡°í•©ë‹ˆë‹¤.
    - ì˜ˆ: "ì‚¬ìš©ìëŠ” 'Marketing'ì„ 'Projects' ì¹´í…Œê³ ë¦¬ì— ì£¼ë¡œ ë„£ì—ˆë‹¤."

3.  **Classification (ë¶„ë¥˜ ìˆ˜í–‰)**:
    - ì…ë ¥ + ë¶„ì„ ë‚´ìš© + ë§¥ë½ ì •ë³´ë¥¼ ì¢…í•©í•˜ì—¬ LLMì´ PARA ë¶„ë¥˜ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
    - ì¶œë ¥: Category, Confidence Score, Reasoning

4.  **Validation (ê²€ì¦)**:
    - LLMì˜ ì¶œë ¥ í˜•ì‹ì´ ì˜¬ë°”ë¥¸ì§€, ì‹ ë¢°ë„ê°€ ì„ê³„ê°’(Threshold) ì´ìƒì¸ì§€ ê²€ì‚¬í•©ë‹ˆë‹¤.
    - **ì¡°ê±´ë¶€ ì—£ì§€**:
        - `í†µê³¼`: ì¢…ë£Œ ë…¸ë“œë¡œ ì´ë™
        - `ì‹¤íŒ¨`: Reflection ë…¸ë“œë¡œ ì´ë™ (ì¬ì‹œë„)

5.  **Reflection (íšŒê³  ë° í”„ë¡¬í”„íŠ¸ ìˆ˜ì •)**:
    - ì™œ ì‹ ë¢°ë„ê°€ ë‚®ì€ì§€, ë˜ëŠ” ì™œ í˜•ì‹ì´ í‹€ë ¸ëŠ”ì§€ ë¶„ì„í•˜ì—¬ í”„ë¡¬í”„íŠ¸ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤.
    - ì˜ˆ: "ì´ì „ ì‹œë„ì—ì„œ 'Resources'ì™€ 'Archives'ë¥¼ í˜¼ë™í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ í•œë²ˆ ì •ì˜ë¥¼ í™•ì¸í•˜ì„¸ìš”."

---

## ğŸ’¾ State ìŠ¤í‚¤ë§ˆ (ë°ì´í„° êµ¬ì¡°)

LangGraphì—ì„œ ë…¸ë“œ ê°„ì— ì „ë‹¬ë˜ëŠ” ìƒíƒœ(State) ë°ì´í„° êµ¬ì¡°ì…ë‹ˆë‹¤.

```python
from typing import TypedDict, List, Optional

class AgentState(TypedDict):
    # ì…ë ¥
    file_content: str
    file_name: str
    
    # ë‚´ë¶€ ì²˜ë¦¬
    extracted_keywords: List[str]
    retrieved_context: str
    retry_count: int
    
    # ì¶œë ¥
    classification_result: Optional[dict]
    confidence_score: float
    reasoning: str
```

---

## ğŸ”Œ í†µí•© ì§€ì 

### `backend/agent/graph.py` (ì‹ ê·œ)
ì—ì´ì „íŠ¸ ì›Œí¬í”Œë¡œìš°ì˜ í•µì‹¬ ê·¸ë˜í”„ ì •ì˜ íŒŒì¼ì…ë‹ˆë‹¤.

```python
# ì˜ì‚¬ ì½”ë“œ
from langgraph.graph import StateGraph, END
from backend.agent.state import AgentState
from backend.agent.nodes import (
    analyze_input,
    retrieve_context,
    classify_document,
    reflect_on_error,
    should_retry
)

def create_workflow():
    """LangGraph ì›Œí¬í”Œë¡œìš° ìƒì„±"""
    workflow = StateGraph(AgentState)
    
    # ë…¸ë“œ ì¶”ê°€
    workflow.add_node("analyze", analyze_input)
    workflow.add_node("retrieve", retrieve_context)
    workflow.add_node("classify", classify_document)
    workflow.add_node("reflect", reflect_on_error)
    
    # ì§„ì…ì  ì„¤ì •
    workflow.set_entry_point("analyze")
    
    # ì—£ì§€ ì¶”ê°€
    workflow.add_edge("analyze", "retrieve")
    workflow.add_edge("retrieve", "classify")
    workflow.add_conditional_edges(
        "classify",
        should_retry,
        {
            "end": END,
            "retry": "reflect"
        }
    )
    workflow.add_edge("reflect", "classify")
    
    return workflow.compile()
```

### `backend/services/classifier_service.py` (ìˆ˜ì •)
ê¸°ì¡´ ì„œë¹„ìŠ¤ë¥¼ ì—ì´ì „íŠ¸ ë˜í¼ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.

```python
from backend.agent.graph import create_workflow

class ClassifierService:
    def __init__(self):
        self.agent = create_workflow()
    
    async def classify(self, file_content: str, file_name: str) -> dict:
        """ì—ì´ì „íŠ¸ë¥¼ í†µí•œ ë¶„ë¥˜ (ê¸°ì¡´ ì¸í„°í˜ì´ìŠ¤ ìœ ì§€)"""
        result = await self.agent.ainvoke({
            "file_content": file_content,
            "file_name": file_name,
            "extracted_keywords": [],
            "retrieved_context": "",
            "retry_count": 0,
            "classification_result": None,
            "confidence_score": 0.0,
            "reasoning": ""
        })
        return result["classification_result"]
```
