# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# tests/test_chunking_embedding.py
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

"""
ì²­í‚¹ & ì„ë² ë”© í†µí•© í…ŒìŠ¤íŠ¸
"""

import sys
from pathlib import Path

# í”„ë¡œì íŠ¸ ë£¨íŠ¸ ì¶”ê°€ (ìƒìœ„ í´ë”)
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from backend.chunking import chunk_text, chunk_with_metadata
from backend.embedding import get_embeddings
from backend.utils import read_file

def test_full_pipeline():
    """ì „ì²´ íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸"""
    
    print("=" * 50)
    print("FlowNote ì²­í‚¹ & ì„ë² ë”© í…ŒìŠ¤íŠ¸")
    print("=" * 50)
    
    # 1. ìƒ˜í”Œ í…ìŠ¤íŠ¸
    sample_text = """
    FlowNote MVP í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤.
    
    ì´ ë„êµ¬ëŠ” AI ëŒ€í™”ë¥¼ ì²´ê³„ì ìœ¼ë¡œ ì €ì¥í•˜ê³  ê²€ìƒ‰í•©ë‹ˆë‹¤.
    ì‚¬ìš©ìëŠ” Markdown íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³ ,
    í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•˜ì—¬ í•„ìš”í•œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    
    ì£¼ìš” ê¸°ëŠ¥:
    1. íŒŒì¼ ì—…ë¡œë“œ
    2. ìë™ ì²­í‚¹
    3. ë²¡í„° ì„ë² ë”©
    4. FAISS ê²€ìƒ‰
    5. ê²°ê³¼ ìš”ì•½
    
    ê¸°ìˆ  ìŠ¤íƒ:
    - Python 3.11
    - Streamlit
    - OpenAI API
    - FAISS
    """ * 3
    
    # 2. ì²­í‚¹
    print("\n" + "=" * 50)
    print("1. ì²­í‚¹ í…ŒìŠ¤íŠ¸")
    print("=" * 50)
    
    chunks = chunk_text(
        sample_text,
        chunk_size=200,
        chunk_overlap=50
    )
    
    print(f"âœ… ì²­í¬ ìˆ˜: {len(chunks)}")
    print(f"âœ… ì²« ë²ˆì§¸ ì²­í¬ ê¸¸ì´: {len(chunks[0])}")
    print(f"\nì²« ë²ˆì§¸ ì²­í¬ ë¯¸ë¦¬ë³´ê¸°:")
    print(f"{chunks[0][:100]}...")
    
    # 3. ë©”íƒ€ë°ì´í„° í¬í•¨ ì²­í‚¹
    print("\n" + "=" * 50)
    print("2. ë©”íƒ€ë°ì´í„° ì²­í‚¹")
    print("=" * 50)
    
    chunks_meta = chunk_with_metadata(
        sample_text,
        "test.md",
        chunk_size=200,
        chunk_overlap=50
    )
    
    print(f"âœ… ì²­í¬ ìˆ˜: {len(chunks_meta)}")
    print(f"\nì²« ë²ˆì§¸ ì²­í¬ ë©”íƒ€ë°ì´í„°:")
    print(f"  - filename: {chunks_meta[0]['filename']}")
    print(f"  - chunk_id: {chunks_meta[0]['chunk_id']}")
    print(f"  - start_pos: {chunks_meta[0]['start_pos']}")
    print(f"  - end_pos: {chunks_meta[0]['end_pos']}")
    
    # 4. ì„ë² ë”©
    print("\n" + "=" * 50)
    print("3. ì„ë² ë”© í…ŒìŠ¤íŠ¸")
    print("=" * 50)
    
    # ì²˜ìŒ 3ê°œë§Œ í…ŒìŠ¤íŠ¸ (ë¹„ìš© ì ˆì•½)
    test_chunks = [chunk['text'] for chunk in chunks_meta[:3]]
    
    embeddings, tokens, cost = get_embeddings(test_chunks)
    
    if embeddings:
        print(f"\nâœ… ì„ë² ë”© ì„±ê³µ!")
        print(f"  - ì„ë² ë”© ê°œìˆ˜: {len(embeddings)}")
        print(f"  - ë²¡í„° ì°¨ì›: {len(embeddings[0])}")
        print(f"  - ì´ í† í°: {tokens:,}")
        print(f"  - ì´ ë¹„ìš©: ${cost:.6f}")
        
        # 5. ë¹„ìš© ì˜ˆì¸¡
        print("\n" + "=" * 50)
        print("4. ì „ì²´ íŒŒì¼ ë¹„ìš© ì˜ˆì¸¡")
        print("=" * 50)
        
        total_chunks = len(chunks_meta)
        estimated_tokens = tokens * (total_chunks / 3)
        estimated_cost = cost * (total_chunks / 3)
        
        print(f"  - ì „ì²´ ì²­í¬ ìˆ˜: {total_chunks}")
        print(f"  - ì˜ˆìƒ í† í°: {estimated_tokens:,.0f}")
        print(f"  - ì˜ˆìƒ ë¹„ìš©: ${estimated_cost:.6f}")
        
        # 6. ê²°ê³¼ ìš”ì•½
        print("\n" + "=" * 50)
        print("5. í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½")
        print("=" * 50)
        
        print(f"âœ… ì²­í‚¹: ì„±ê³µ ({total_chunks}ê°œ ì²­í¬)")
        print(f"âœ… ì„ë² ë”©: ì„±ê³µ ({len(embeddings)}ê°œ í…ŒìŠ¤íŠ¸)")
        print(f"âœ… ë¹„ìš© ê³„ì‚°: ì„±ê³µ")
        print(f"\nğŸ‰ ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼!")
    
    else:
        print("âŒ ì„ë² ë”© ì‹¤íŒ¨")

if __name__ == "__main__":
    test_full_pipeline()



"""result

    ==================================================
    FlowNote ì²­í‚¹ & ì„ë² ë”© í…ŒìŠ¤íŠ¸
    ==================================================

    ==================================================
    1. ì²­í‚¹ í…ŒìŠ¤íŠ¸
    ==================================================
    âœ… ì²­í¬ ìˆ˜: 6
    âœ… ì²« ë²ˆì§¸ ì²­í¬ ê¸¸ì´: 200

    ì²« ë²ˆì§¸ ì²­í¬ ë¯¸ë¦¬ë³´ê¸°:

        FlowNote MVP í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤.
        
        ì´ ë„êµ¬ëŠ” AI ëŒ€í™”ë¥¼ ì²´ê³„ì ìœ¼ë¡œ ì €ì¥í•˜ê³  ê²€ìƒ‰í•©ë‹ˆë‹¤.
        ì‚¬ìš©ìëŠ” Markdown íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³ ,
        ...

    ==================================================
    2. ë©”íƒ€ë°ì´í„° ì²­í‚¹
    ==================================================
    âœ… ì²­í¬ ìˆ˜: 6

    ì²« ë²ˆì§¸ ì²­í¬ ë©”íƒ€ë°ì´í„°:
        - filename: test.md
        - chunk_id: 0
        - start_pos: 0
        - end_pos: 200

    ==================================================
    3. ì„ë² ë”© í…ŒìŠ¤íŠ¸
    ==================================================
    ğŸ“Š ì„ë² ë”© ìƒì„± ì¤‘... (3ê°œ ì²­í¬)
    âœ… ì„ë² ë”© ì™„ë£Œ!
        - ì²­í¬ ìˆ˜: 3
        - í† í° ìˆ˜: 353
        - ì˜ˆìƒ ë¹„ìš©: $0.000007
        - ë²¡í„° ì°¨ì›: 1536

    âœ… ì„ë² ë”© ì„±ê³µ!
        - ì„ë² ë”© ê°œìˆ˜: 3
        - ë²¡í„° ì°¨ì›: 1536
        - ì´ í† í°: 353
        - ì´ ë¹„ìš©: $0.000007

    ==================================================
    4. ì „ì²´ íŒŒì¼ ë¹„ìš© ì˜ˆì¸¡
    ==================================================
        - ì „ì²´ ì²­í¬ ìˆ˜: 6
        - ì˜ˆìƒ í† í°: 706
        - ì˜ˆìƒ ë¹„ìš©: $0.000014

    ==================================================
    5. í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
    ==================================================
    âœ… ì²­í‚¹: ì„±ê³µ (6ê°œ ì²­í¬)
    âœ… ì„ë² ë”©: ì„±ê³µ (3ê°œ í…ŒìŠ¤íŠ¸)
    âœ… ë¹„ìš© ê³„ì‚°: ì„±ê³µ

    ğŸ‰ ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼!

"""